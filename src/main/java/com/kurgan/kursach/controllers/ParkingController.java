package com.kurgan.kursach.controllers;import com.kurgan.kursach.models.Car;import com.kurgan.kursach.models.Card;import com.kurgan.kursach.models.Parking;import com.kurgan.kursach.models.User;import com.kurgan.kursach.service.CarService;import com.kurgan.kursach.service.ParkingService;import com.kurgan.kursach.service.UserService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.core.Authentication;import org.springframework.security.core.context.SecurityContextHolder;import org.springframework.stereotype.Controller;import org.springframework.ui.Model;import org.springframework.ui.ModelMap;import org.springframework.web.bind.annotation.GetMapping;import org.springframework.web.bind.annotation.ModelAttribute;import org.springframework.web.bind.annotation.PostMapping;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.servlet.mvc.support.RedirectAttributes;import java.sql.Timestamp;import java.text.DateFormat;import java.text.ParseException;import java.text.SimpleDateFormat;import java.time.LocalDate;import java.util.*;@Controller@RequestMapping("/car")public class ParkingController {    @Autowired    private UserService userService;    @Autowired    private CarService carService;    @Autowired    private ParkingService parkingService;    @GetMapping("add")    public String addParking(Model model) {        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();        String username = authentication.getName();        Set<Car> cars = new HashSet<>();        for (Car car : userService.findByUsername(username).getCars()) {            if (car.getParking() == null) {                cars.add(car);            }        }        model.addAttribute("cars", cars);        model.addAttribute("parkings", parkingService.findAll());        return "parking/add";    }    @PostMapping("add")    public String addParking(@ModelAttribute("parking") Long parking_id, @ModelAttribute("car") Long car_id) throws ParseException {        Parking parking = parkingService.getById(parking_id);        parking.getCars().add(carService.findById(car_id));        parkingService.save(parking);        Car car = carService.findById(car_id);        car.setDate(parseTime());        carService.save(car);        return "redirect:add";    }    @GetMapping("delete")    public String deleteParking(Model model) {        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();        String username = authentication.getName();        Set<Car> cars = new HashSet<>();        for (Car car : userService.findByUsername(username).getCars()) {            if (car.getParking() != null) {                cars.add(car);            }        }        model.addAttribute("cars", cars);        return "parking/delete";    }    @PostMapping("delete")    public String deleteParking(@ModelAttribute("car") Long id, RedirectAttributes redirectAttributes) throws ParseException {        Car car = carService.findById(id);        redirectAttributes.addFlashAttribute("hours", countTime(car.getDate()) + 1);        car.setParking(null);        car.setDate(null);        carService.save(car);        return "redirect:show";    }    @GetMapping("show")    public String showResult(Model model) {        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();        String username = authentication.getName();        User user = userService.findByUsername(username);        Card card = null;        if (user.getCard() != null) {            card = user.getCard();        }        model.addAttribute("price", Double.parseDouble(String.valueOf(model.getAttribute("hours"))) * 2 * (100 - card.getDiscount()) / 100);        return "parking/show";    }    private Timestamp parseTime() throws ParseException {        java.util.Date utilDate = new Date();        String pt = (new java.sql.Timestamp(utilDate.getTime())).toString();        long tm0 = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").parse(pt).getTime();        long tm1 = new SimpleDateFormat("HH:mm:ss").parse("03:30:00").getTime();        return new Timestamp(tm0 + tm1);    }    private int countTime(Timestamp date) throws ParseException {        java.util.Date utilDate = new Date();        String pt = (new java.sql.Timestamp(utilDate.getTime())).toString();        long tm0 = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").parse(date.toString()).getTime();        long tm1 = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").parse(pt).getTime();        long time = tm1 - tm0;        double hours = (double) (time / 3600000L);        return (int) Math.ceil(hours);    }}